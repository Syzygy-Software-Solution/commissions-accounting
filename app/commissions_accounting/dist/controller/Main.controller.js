sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/BusyIndicator","sap/ui/core/Fragment"],(e,t,o,r,s,a)=>{"use strict";return e.extend("commissionsaccounting.controller.Main",{async onInit(){const e=new t({overview:[],schedule:[],setupForm:{selectedProduct:null,capPercent:null,paymentStartDate:null},currentSetups:[],selectedSetupIndex:undefined});this.getView().setModel(e);var o=new t([]);this.getView().setModel(o,"currentSetups");var r=new t([]);this.getView().setModel(r,"scheduleData");var s=new t([]);this.getView().setModel(s,"overviewData");var a=new t([]);this.getView().setModel(a,"periodsData");await this.getCurrentSetups();await this.getAllPeriods();this._loadSheetJS();this._oSelectedFile=null},_loadSheetJS(){if(!window.XLSX){const e=document.createElement("script");e.src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js";e.async=true;e.onload=()=>{console.log("SheetJS library loaded successfully")};e.onerror=()=>{console.error("Failed to load SheetJS library")};document.head.appendChild(e)}},async onUploadPress(){if(!this._pUploadDialog){this._pUploadDialog=a.load({id:this.getView().getId(),name:"commissionsaccounting.view.fragments.UploadDialog",controller:this}).then(e=>{this.getView().addDependent(e);return e})}const e=await this._pUploadDialog;e.open()},onFileSelect(e){const t=e.getSource();const o=e.getParameter("files")&&e.getParameter("files")[0];if(o){this._oSelectedFile=o}else{this._oSelectedFile=null}},async onUploadFile(){if(!this._oSelectedFile){r.warning("Please select a file to upload");return}if(!this._oSelectedFile.name.match(/\.(xlsx|xls)$/)){r.error("Please upload a valid Excel file (.xlsx or .xls)");return}if(!window.XLSX){r.error("Excel processing library is still loading. Please try again in a moment.");return}s.show(0);try{const e=await this._readFileAsArrayBuffer(this._oSelectedFile);const t=XLSX.read(new Uint8Array(e),{type:"array"});const s=t.Sheets[t.SheetNames[0]];const a=XLSX.utils.sheet_to_json(s);if(a.length===0){r.warning("The uploaded Excel file is empty");return}const n=["PayeeId","Total Incentive","Product","Cap %","Term","Payment Frequency","Payment Start Date"];const i=a[0];const l=n.filter(e=>!(e in i));if(l.length>0){r.error(`Missing required columns: ${l.join(", ")}`);return}const c=this.getView().getModel();c.setProperty("/overview",a);const d=[...new Set(a.map(e=>e.PayeeId))].filter(Boolean);const p=d.map(e=>({id:e}));c.setProperty("/payeeIds",p);const u=[...new Set(a.map(e=>e.Product))].filter(Boolean);const h=u.map(e=>({id:e}));c.setProperty("/products",h);c.setProperty("/setupForm",{selectedProduct:null,capPercent:null,paymentStartDate:null});o.show(`Successfully loaded ${a.length} record(s)`);this._calculateAmortizationSchedule(a);this.onCloseUploadDialog()}catch(e){r.error("Error parsing Excel file: "+e.message)}finally{s.hide()}},onCloseUploadDialog(){this._pUploadDialog.then(e=>{e.close();const t=this.byId("fileUploader");if(t){t.clear()}this._oSelectedFile=null})},_readFileAsArrayBuffer(e){return new Promise((t,o)=>{const r=new FileReader;r.onload=e=>t(e.target.result);r.onerror=e=>o(new Error("Error reading file"));r.readAsArrayBuffer(e)})},_calculateAmortizationSchedule(e){const t=this.getView().getModel();const o=[];e.forEach(e=>{try{const t=e.PayeeId||"";const r=e.Product||"";const s=parseFloat(e["Total Incentive"])||0;const a=parseFloat(e["Cap %"])||100;const n=parseInt(e["Term"])||12;let i;if(e["Payment Start Date"]){if(typeof e["Payment Start Date"]==="number"){i=this._excelDateToJSDate(e["Payment Start Date"])}else{i=new Date(e["Payment Start Date"])}}else{i=new Date}const l=e["Payment Frequency"]||"Monthly";const c={Monthly:1,Quarterly:3,"Bi-Monthly":2,"Semi-Annually":6,Annually:12}[l]||1;const d=Math.floor(n/c);const p=s*(a/100);const u=p/d;let h=new Date(i);for(let e=1;e<=d;e++){o.push({PayeeId:t,Product:r,Installment:e,PaymentDate:this._formatDate(h),PaymentAmount:this._formatCurrency(u)});h=this._addMonths(h,c)}}catch(t){console.error("Error calculating amortization for record:",e,t)}});const r=this.getView().getModel("scheduleData");r.setData(o);t.setProperty("/scheduleOriginal",null);t.setProperty("/isFiltered",false);t.setProperty("/currentFilter",null)},async onDownloadTemplatePress(){if(!window.XLSX){r.error("Excel processing library is still loading. Please try again in a moment.");return}try{s.show(0);const e=[{PayeeId:"",Product:"","Total Incentive":"","Cap %":"",Term:"","Payment Frequency":"","Payment Start Date":"",Plan:"","Data Type":"","Data Type Name":"","Account Type":"","Payroll Classification":"","Expense Start Date":"","Expense End Date":"",Notes:""}];const t=XLSX.utils.json_to_sheet(e);const r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,t,"Template");t["!cols"]=[{wch:15},{wch:15},{wch:18},{wch:10},{wch:10},{wch:20},{wch:20},{wch:15},{wch:15},{wch:18},{wch:15},{wch:22},{wch:20},{wch:20},{wch:30}];XLSX.writeFile(r,"Commissions_Template.xlsx");o.show("Template downloaded successfully")}catch(e){r.error("Error generating template: "+e.message)}finally{s.hide()}},async onDownloadSetupTemplatePress(){if(!window.XLSX){r.error("Excel processing library is still loading. Please try again in a moment.");return}s.show(0);try{const e=[{Product:"","Cap %":"",Term:"","Payment Frequency":"","Payroll Classification":"","Payment Start Date":""}];const t=XLSX.utils.json_to_sheet(e);t["!cols"]=[{wch:15},{wch:10},{wch:10},{wch:20},{wch:25},{wch:20}];const r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,t,"Setup Template");XLSX.writeFile(r,"Setup_Template.xlsx");o.show("Setup template downloaded successfully")}catch(e){r.error("Error generating template: "+e.message)}finally{s.hide()}},async onDownloadAmortizationTemplatePress(){if(!window.XLSX){r.error("Excel processing library is still loading. Please try again in a moment.");return}s.show(0);try{const e=[{payeeId:"",orderId:"",product:"",totalIncentive:""}];const t=XLSX.utils.json_to_sheet(e);t["!cols"]=[{wch:15},{wch:15},{wch:15},{wch:20}];const r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,t,"Amortization Template");XLSX.writeFile(r,"Amortization_Template.xlsx");o.show("Amortization template downloaded successfully")}catch(e){r.error("Error generating template: "+e.message)}finally{s.hide()}},onDownloadSchedulePress(){if(!window.XLSX){r.error("Excel processing library is still loading. Please try again in a moment.");return}const e=this.getView().getModel("scheduleData");const t=e.getData();if(!t||t.length===0){r.warning("No schedule data available to download");return}try{s.show(0);const e=XLSX.utils.json_to_sheet(t);const r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,e,"Amortization Schedule");e["!cols"]=[{wch:15},{wch:15},{wch:18},{wch:18}];const a=(new Date).toISOString().split("T")[0];const n=`Amortization_Schedule_${a}.xlsx`;XLSX.writeFile(r,n);o.show(`Successfully downloaded ${t.length} record(s)`)}catch(e){r.error("Error generating Excel file: "+e.message)}finally{s.hide()}},_excelDateToJSDate(e){const t=24*60*60*1e3;const o=e>59?1:0;const r=new Date((e-25569+o)*t);return r},_addMonths(e,t){const o=new Date(e);o.setMonth(o.getMonth()+t);return o},_formatDate(e){const t=e.getFullYear();const o=String(e.getMonth()+1).padStart(2,"0");const r=String(e.getDate()).padStart(2,"0");return`${t}-${o}-${r}`},_formatCurrency(e){return Math.round(e*100)/100},async onExecuteAmortizationPress(){s.show(0);try{const e=[{payeeId:"EMP-101",orderId:"1000234",product:"Cloud",totalIncentive:12e3},{payeeId:"EMP-101",orderId:"1000234",product:"On-Prem",totalIncentive:12e3},{payeeId:"EMP-101",orderId:"1000235",product:"Cloud",totalIncentive:1e4},{payeeId:"EMP-101",orderId:"1000235",product:"Cloud",totalIncentive:1e4}];const t=this.getView().getModel("currentSetups");const a=t.getData()||[];if(a.length===0){r.warning("No setup data available. Please add setup configurations first.");s.hide();return}const n=this._executeAmortizationCalculation(e,a);const i=this._prepareOverviewData(e,a);const l=this.getView().getModel("scheduleData");l.setData(n);const c=this.getView().getModel("overviewData");c.setData(i);const d=this.getView().getModel();d.setProperty("/scheduleOriginal",null);d.setProperty("/overviewOriginal",null);d.setProperty("/isFiltered",false);d.setProperty("/currentFilter",null);const p=[...new Set(n.map(e=>e.PayeeId))].filter(Boolean);const u=p.map(e=>({id:e}));d.setProperty("/schedulePayeeIds",u);const h=[...new Set(n.map(e=>e.Product))].filter(Boolean);const y=h.map(e=>({id:e}));d.setProperty("/scheduleProducts",y);const g=[...new Set(n.map(e=>e["Payroll Classification"]))].filter(Boolean);const m=g.map(e=>({id:e}));d.setProperty("/schedulePayrollClassifications",m);const f=[...new Set(i.map(e=>e.PayeeId))].filter(Boolean);const w=f.map(e=>({id:e}));d.setProperty("/overviewPayeeIds",w);const P=[...new Set(i.map(e=>e.Product))].filter(Boolean);const S=P.map(e=>({id:e}));d.setProperty("/overviewProducts",S);const I=[...new Set(i.map(e=>e["Payroll Classification"]))].filter(Boolean);const D=I.map(e=>({id:e}));d.setProperty("/overviewPayrollClassifications",D);const v=this.byId("schedulePayeeFilter");if(v){v.setSelectedKeys([])}const F=this.byId("scheduleProductFilter");if(F){F.setSelectedKeys([])}const C=this.byId("schedulePayrollClassificationFilter");if(C){C.setSelectedKeys([])}const _=this.byId("overviewPayeeFilter");if(_){_.setSelectedKeys([])}const b=this.byId("overviewProductFilter");if(b){b.setSelectedKeys([])}const T=this.byId("overviewPayrollClassificationFilter");if(T){T.setSelectedKeys([])}o.show(`Amortization executed successfully: ${n.length} schedule entries and ${i.length} overview records`)}catch(e){r.error("Error executing amortization: "+e.message)}finally{s.hide()}},async onUploadAmortizationDataPress(){if(!this._pUploadAmortizationDialog){this._pUploadAmortizationDialog=a.load({id:this.getView().getId(),name:"commissionsaccounting.view.fragments.UploadAmortizationDialog",controller:this}).then(e=>{this.getView().addDependent(e);return e})}const e=await this._pUploadAmortizationDialog;e.open()},onAmortizationFileSelect(e){const t=e.getParameter("files")&&e.getParameter("files")[0];if(t){this._oSelectedAmortizationFile=t}else{this._oSelectedAmortizationFile=null}},async onUploadAmortizationFile(){if(!this._oSelectedAmortizationFile){r.warning("Please select a file to upload");return}if(!this._oSelectedAmortizationFile.name.match(/\.(xlsx|xls)$/)){r.error("Please upload a valid Excel file (.xlsx or .xls)");return}if(!window.XLSX){r.error("Excel processing library is still loading. Please try again in a moment.");return}s.show(0);try{const e=await this._readFileAsArrayBuffer(this._oSelectedAmortizationFile);const t=XLSX.read(new Uint8Array(e),{type:"array"});const a=t.Sheets[t.SheetNames[0]];const n=XLSX.utils.sheet_to_json(a);if(n.length===0){r.error("The uploaded file is empty");s.hide();return}const i=["payeeId","orderId","product","totalIncentive"];const l=n[0];const c=i.filter(e=>!(e in l));if(c.length>0){r.error(`Missing required columns: ${c.join(", ")}`);s.hide();return}for(let e=0;e<n.length;e++){const t=n[e];if(!t.payeeId||!t.orderId||!t.product||!t.totalIncentive){r.error(`Row ${e+2}: All fields are required (payeeId, orderId, product, totalIncentive)`);s.hide();return}if(isNaN(parseFloat(t.totalIncentive))||parseFloat(t.totalIncentive)<=0){r.error(`Row ${e+2}: totalIncentive must be a valid positive number`);s.hide();return}}this.onCloseUploadAmortizationDialog();o.show(`Successfully loaded ${n.length} record(s)`);const d=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);const p=await fetch(`${d}/AmortizationSetups`);const u=await p.json();const h=u.value||[];if(h.length===0){r.warning("No setup configuration found. Please add setup data before executing amortization.");s.hide();return}const y=n.map(e=>({payeeId:e.payeeId,orderId:e.orderId,product:e.product,totalIncentive:parseFloat(e.totalIncentive)}));const g=this._executeAmortizationCalculation(y,h);const m=this._prepareOverviewData(y,h);const f=this.getView().getModel("scheduleData");f.setData(g);const w=this.getView().getModel("overviewData");w.setData(m);const P=this.getView().getModel();P.setProperty("/scheduleOriginal",null);P.setProperty("/overviewOriginal",null);P.setProperty("/isFiltered",false);P.setProperty("/currentFilter",null);const S=[...new Set(g.map(e=>e.PayeeId))].filter(Boolean);const I=S.map(e=>({id:e}));P.setProperty("/schedulePayeeIds",I);const D=[...new Set(g.map(e=>e.Product))].filter(Boolean);const v=D.map(e=>({id:e}));P.setProperty("/scheduleProducts",v);const F=[...new Set(g.map(e=>e["Payroll Classification"]))].filter(Boolean);const C=F.map(e=>({id:e}));P.setProperty("/schedulePayrollClassifications",C);const _=[...new Set(m.map(e=>e.PayeeId))].filter(Boolean);const b=_.map(e=>({id:e}));P.setProperty("/overviewPayeeIds",b);const T=[...new Set(m.map(e=>e.Product))].filter(Boolean);const E=T.map(e=>({id:e}));P.setProperty("/overviewProducts",E);const x=[...new Set(m.map(e=>e["Payroll Classification"]))].filter(Boolean);const M=x.map(e=>({id:e}));P.setProperty("/overviewPayrollClassifications",M);const A=this.byId("schedulePayeeFilter");if(A){A.setSelectedKeys([])}const O=this.byId("scheduleProductFilter");if(O){O.setSelectedKeys([])}const V=this.byId("schedulePayrollClassificationFilter");if(V){V.setSelectedKeys([])}const X=this.byId("overviewPayeeFilter");if(X){X.setSelectedKeys([])}const $=this.byId("overviewProductFilter");if($){$.setSelectedKeys([])}const z=this.byId("overviewPayrollClassificationFilter");if(z){z.setSelectedKeys([])}o.show(`Amortization executed successfully: ${g.length} schedule entries and ${m.length} overview records`)}catch(e){r.error("Error parsing Excel file: "+e.message)}finally{s.hide()}},onCloseUploadAmortizationDialog(){this._pUploadAmortizationDialog.then(e=>{e.close();const t=this.byId("amortizationFileUploader");if(t){t.clear()}this._oSelectedAmortizationFile=null})},async onRefreshSchedule(){const e=this.getView().getModel("scheduleData");const t=this.getView().getModel("overviewData");const a=this.getView().getModel();const n=e.getData();const i=t.getData();if((!n||n.length===0)&&(!i||i.length===0)){r.warning("No data to refresh. Please execute amortization or upload data first.");return}s.show(0);try{const l=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);const c=await fetch(`${l}/AmortizationSetups`);const d=await c.json();const p=d.value||[];if(p.length===0){r.warning("No setup configuration found. Please add setup data before refreshing.");s.hide();return}let u=[];if(i&&i.length>0){u=i.map(e=>({payeeId:e.PayeeId,orderId:e.OrderId||"",product:e.Product,totalIncentive:parseFloat(e["Total Incentive"])||0}))}else if(n&&n.length>0){const e=new Map;n.forEach(t=>{const o=`${t.PayeeId}-${t.OrderId}-${t.Product}`;if(!e.has(o)){e.set(o,{payeeId:t.PayeeId,orderId:t.OrderId||"",product:t.Product,totalIncentive:parseFloat(t["Total Incentive"])||0})}});u=Array.from(e.values())}if(u.length===0){r.warning("Unable to extract payee data for refresh. Please re-execute amortization.");s.hide();return}const h=this._executeAmortizationCalculation(u,p);const y=this._prepareOverviewData(u,p);e.setData(h);t.setData(y);a.setProperty("/scheduleOriginal",null);a.setProperty("/overviewOriginal",null);a.setProperty("/isFiltered",false);a.setProperty("/currentFilter",null);const g=[...new Set(h.map(e=>e.PayeeId))].filter(Boolean);const m=g.map(e=>({id:e}));a.setProperty("/schedulePayeeIds",m);const f=[...new Set(h.map(e=>e.Product))].filter(Boolean);const w=f.map(e=>({id:e}));a.setProperty("/scheduleProducts",w);const P=[...new Set(h.map(e=>e["Payroll Classification"]))].filter(Boolean);const S=P.map(e=>({id:e}));a.setProperty("/schedulePayrollClassifications",S);const I=[...new Set(y.map(e=>e.PayeeId))].filter(Boolean);const D=I.map(e=>({id:e}));a.setProperty("/overviewPayeeIds",D);const v=[...new Set(y.map(e=>e.Product))].filter(Boolean);const F=v.map(e=>({id:e}));a.setProperty("/overviewProducts",F);const C=[...new Set(y.map(e=>e["Payroll Classification"]))].filter(Boolean);const _=C.map(e=>({id:e}));a.setProperty("/overviewPayrollClassifications",_);const b=this.byId("schedulePayeeFilter");if(b){b.setSelectedKeys([])}const T=this.byId("scheduleProductFilter");if(T){T.setSelectedKeys([])}const E=this.byId("schedulePayrollClassificationFilter");if(E){E.setSelectedKeys([])}const x=this.byId("overviewPayeeFilter");if(x){x.setSelectedKeys([])}const M=this.byId("overviewProductFilter");if(M){M.setSelectedKeys([])}const A=this.byId("overviewPayrollClassificationFilter");if(A){A.setSelectedKeys([])}o.show(`Data refreshed successfully: ${h.length} schedule entries and ${y.length} overview records`)}catch(e){r.error("Error refreshing data: "+e.message)}finally{s.hide()}},_executeAmortizationCalculation(e,t){const o=[];e.forEach(e=>{try{const r=t.find(t=>t.product===e.product);if(!r){console.warn(`No setup found for product: ${e.product}. Skipping this record.`);return}const s=e.payeeId||"";const a=e.orderId||"";const n=e.product||"";const i=parseFloat(e.totalIncentive)||0;const l=parseFloat(r.capPercent)||100;const c=parseInt(r.term)||12;const d=r.paymentFrequency||"Monthly";const p=r.payrollClassification||"";let u;if(r.paymentStartDate){if(typeof r.paymentStartDate==="number"){u=this._excelDateToJSDate(r.paymentStartDate)}else{u=new Date(r.paymentStartDate)}}else{u=new Date}if(p==="Non-Deferred"){const e=i*(l/100);o.push({PayeeId:s,OrderId:a,Product:n,"Total Incentive":this._formatCurrency(e),"Cap %":l,Term:0,"Payment Frequency":"One-time","Payment Start Date":this._formatDate(u),Plan:"","Data Type":"","Data Type Name":"","Account Type":"","Payroll Classification":p,Notes:"Non-Deferred Payment"})}else{const e={Monthly:1,Quarterly:3,"Bi-Monthly":2,"Semi-Annually":6,Annually:12}[d]||1;const t=Math.floor(c/e);const r=i*(l/100);const h=r/t;let y=new Date(u);for(let r=1;r<=t;r++){o.push({PayeeId:s,OrderId:a,Product:n,"Total Incentive":this._formatCurrency(h),"Cap %":l,Term:c,"Payment Frequency":d,"Payment Start Date":this._formatDate(u),Plan:"","Data Type":"","Data Type Name":"","Account Type":"","Payroll Classification":p,Notes:`Installment ${r} of ${t}`});y=this._addMonths(y,e)}}}catch(t){console.error("Error calculating amortization for payee record:",e,t)}});return o},_prepareOverviewData(e,t){const o=[];e.forEach(e=>{try{const r=t.find(t=>t.product===e.product);if(!r){console.warn(`No setup found for product: ${e.product}. Skipping this record.`);return}let s;if(r.paymentStartDate){if(typeof r.paymentStartDate==="number"){s=this._excelDateToJSDate(r.paymentStartDate)}else{s=new Date(r.paymentStartDate)}}else{s=new Date}o.push({PayeeId:e.payeeId||"",OrderId:e.orderId||"",Product:e.product||"","Total Incentive":this._formatCurrency(e.totalIncentive||0),"Cap %":parseFloat(r.capPercent)||100,Term:parseInt(r.term)||12,"Payment Frequency":r.paymentFrequency||"Monthly","Payment Start Date":this._formatDate(s),Plan:"","Data Type":"","Data Type Name":"","Account Type":"","Payroll Classification":r.payrollClassification||"","Expense Start Date":"","Expense End Date":"",Notes:""})}catch(t){console.error("Error preparing overview for payee record:",e,t)}});return o},onSchedulePayeeFilterChange(e){this._applyScheduleFilters()},onScheduleProductFilterChange(e){this._applyScheduleFilters()},onSchedulePayrollClassificationFilterChange(e){this._applyScheduleFilters()},_applyScheduleFilters(){const e=this.getView().getModel();const t=this.getView().getModel("scheduleData");const o=e.getProperty("/scheduleOriginal")||t.getData();if(!e.getProperty("/scheduleOriginal")){e.setProperty("/scheduleOriginal",[...o])}const r=this.byId("schedulePayeeFilter");const s=this.byId("scheduleProductFilter");const a=this.byId("schedulePayrollClassificationFilter");const n=r?r.getSelectedKeys():[];const i=s?s.getSelectedKeys():[];const l=a?a.getSelectedKeys():[];const c=n&&n.length>0||i&&i.length>0||l&&l.length>0;if(!c){t.setData([...o]);e.setProperty("/isFiltered",false);e.setProperty("/currentFilter",null)}else{let r=[...o];if(n&&n.length>0){r=r.filter(e=>n.includes(e.PayeeId))}if(i&&i.length>0){r=r.filter(e=>i.includes(e.Product))}if(l&&l.length>0){r=r.filter(e=>l.includes(e["Payroll Classification"]))}t.setData(r);e.setProperty("/isFiltered",true);const s=[];if(n&&n.length>0){s.push(`Payee: ${n.join(", ")}`)}if(i&&i.length>0){s.push(`Product: ${i.join(", ")}`)}if(l&&l.length>0){s.push(`Classification: ${l.join(", ")}`)}e.setProperty("/currentFilter",s.join(" | "))}},onOverviewPayeeFilterChange(e){this._applyOverviewFilters()},onOverviewProductFilterChange(e){this._applyOverviewFilters()},onOverviewPayrollClassificationFilterChange(e){this._applyOverviewFilters()},_applyOverviewFilters(){const e=this.getView().getModel();const t=this.getView().getModel("overviewData");const o=e.getProperty("/overviewOriginal")||t.getData();if(!e.getProperty("/overviewOriginal")){e.setProperty("/overviewOriginal",[...o])}const r=this.byId("overviewPayeeFilter");const s=this.byId("overviewProductFilter");const a=this.byId("overviewPayrollClassificationFilter");const n=r?r.getSelectedKeys():[];const i=s?s.getSelectedKeys():[];const l=a?a.getSelectedKeys():[];const c=n&&n.length>0||i&&i.length>0||l&&l.length>0;if(!c){t.setData([...o])}else{let e=[...o];if(n&&n.length>0){e=e.filter(e=>n.includes(e.PayeeId))}if(i&&i.length>0){e=e.filter(e=>i.includes(e.Product))}if(l&&l.length>0){e=e.filter(e=>l.includes(e["Payroll Classification"]))}t.setData(e)}},async onFilterPress(){const e=this.getView().getModel();const t=e.getProperty("/overview");if(!t||t.length===0){r.warning("No data available to filter");return}const o=[...new Set(t.map(e=>e.PayeeId))].filter(Boolean);if(o.length===0){r.warning("No Payee IDs found in the data");return}const s=o.map(e=>({id:e}));e.setProperty("/payeeIds",s);this._aSelectedPayeeIds=[];if(!this._pFilterDialog){this._pFilterDialog=a.load({id:this.getView().getId(),name:"commissionsaccounting.view.fragments.FilterDialog",controller:this}).then(e=>{this.getView().addDependent(e);return e})}const n=await this._pFilterDialog;const i=this.byId("payeeIdMultiCombo");if(i){i.setSelectedKeys([])}n.open()},onPayeeIdSelectionChange(e){const t=e.getSource();const o=t.getSelectedItems();this._aSelectedPayeeIds=o.map(e=>e.getKey())},onApplyFilter(){if(!this._aSelectedPayeeIds||this._aSelectedPayeeIds.length===0){r.warning("Please select at least one Payee ID");return}const e=this.getView().getModel();const t=this.getView().getModel("scheduleData");const s=e.getProperty("/scheduleOriginal")||t.getData();if(!e.getProperty("/scheduleOriginal")){e.setProperty("/scheduleOriginal",[...s])}const a=s.filter(e=>this._aSelectedPayeeIds.includes(e.PayeeId));t.setData(a);e.setProperty("/isFiltered",true);e.setProperty("/currentFilter",this._aSelectedPayeeIds.join(", "));const n=this._aSelectedPayeeIds.length===1?`Filtered by Payee ID: ${this._aSelectedPayeeIds[0]}`:`Filtered by ${this._aSelectedPayeeIds.length} Payee IDs`;o.show(n);this._pFilterDialog.then(e=>{e.close()})},onClearFilter(){const e=this.getView().getModel();const t=this.getView().getModel("scheduleData");const r=e.getProperty("/scheduleOriginal");if(r){t.setData([...r])}e.setProperty("/isFiltered",false);e.setProperty("/currentFilter",null);this._aSelectedPayeeIds=[];const s=this.byId("payeeIdMultiCombo");if(s){s.setSelectedKeys([])}o.show("Filter cleared");this._pFilterDialog.then(e=>{e.close()})},onSetupProductChange(e){const t=e.getParameter("selectedItem").getKey();const o=this.getView().getModel();const r=o.getProperty("/overview");const s=r.filter(e=>e.Product===t);if(s.length>0){const e=s[0];o.setProperty("/setupForm",{selectedProduct:t,capPercent:e["Cap %"]||null,paymentStartDate:this._formatDateForPicker(e["Payment Start Date"])})}else{o.setProperty("/setupForm",{selectedProduct:t,capPercent:null,paymentStartDate:null})}},onSaveSetup(){const e=this.byId("productComboBox");const t=this.byId("totalIncentiveInput");const a=this.byId("termInput");const n=this.byId("paymentFrequencyComboBox");const i=this.byId("payrollClassificationComboBox");const l=this.byId("planInput");const c=this.byId("dataTypeComboBox");const d=this.byId("accountTypeComboBox");const p=this.byId("expenseStartDatePicker");const u=this.byId("expenseEndDatePicker");const h=e.getSelectedKey();const y=t.getValue();const g=a.getValue();const m=n.getSelectedKey();const f=i.getSelectedKey();const w=l.getValue();const P=c.getSelectedKey();const S=d.getSelectedKey();const I=p.getValue();const D=u.getValue();const v=parseFloat(y);const F=parseInt(g);if(isNaN(v)||v<=0){r.error("Total Incentive must be a positive number");return}if(isNaN(F)||F<=0){r.error("Term must be a positive integer");return}s.show(0);try{const e=this.getView().getModel();const t={product:h,capPercent:0,term:F,paymentFrequency:m,dataType:P,accountType:S,plan:w||"",payrollClassification:f,paymentStartDate:I};const a=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);fetch(`${a}/AmortizationSetups`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{s.hide();if(!e.ok){throw new Error("Network response was not ok")}return e.json()}).then(e=>{this.rootId=e?.rootId;o.show("Amortization Setup saved successfully")}).catch(e=>{s.hide();r.error("Error saving Amortization Setup details:",e);console.error("Error saving Amortization Setup details:",e)})}catch(e){s.hide();r.error("Error saving setup: "+e.message)}},async getAllPeriods(){const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.tcmp.uri);try{fetch(`${e}/CS_V_PERIODS/CS_V_PERIODS?$filter=((PERIODTYPESEQ eq 2814749767106569 or PERIODTYPESEQ eq 2814749767106563 or PERIODTYPESEQ eq 2814749767106561) and REMOVEDATE eq 2200-01-01T00:00:00.0000000Z)`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>{if(!e.ok){throw new Error("Network response was not ok")}return e.json()}).then(e=>{const t=e.value||[];const o=t.map(e=>{const t=e.STARTDATE?e.STARTDATE.split("T")[0]:"";const o=e.ENDDATE?e.ENDDATE.split("T")[0]:"";return{...e,PERIOD_RANGE:`${t} to ${o}`}});this.getView().getModel("periodsData").setData(o)}).catch(e=>{r.error("Error fetching periods: "+e.message);console.error("Error fetching periods:",e)})}catch(e){r.error("Error fetching periods: "+e.message)}},async getCurrentSetups(){const e=this.getView().getModel();const t=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);try{fetch(`${t}/AmortizationSetups`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>{if(!e.ok){throw new Error("Network response was not ok")}return e.json()}).then(e=>{this.getView().getModel("currentSetups").setData(e.value||[])}).catch(e=>{r.error("Error fetching current setups: "+e.message);console.error("Error fetching current setups:",e)})}catch(e){r.error("Error fetching current setups: "+e.message)}},onCancelSetup(){r.confirm("Are you sure you want to clear the setup details?",{title:"Confirm",onClose:e=>{if(e===r.Action.OK){this._clearSetupForm();o.show("Form cleared")}}})},_clearSetupForm(){this.byId("productComboBox").setSelectedKey("");this.byId("totalIncentiveInput").setValue("");this.byId("termInput").setValue("");this.byId("paymentFrequencyComboBox").setSelectedKey("");this.byId("payrollClassificationComboBox").setSelectedKey("");this.byId("planInput").setValue("");this.byId("dataTypeComboBox").setSelectedKey("");this.byId("accountTypeComboBox").setSelectedKey("");this.byId("expenseStartDatePicker").setValue("");this.byId("expenseEndDatePicker").setValue("")},onResetSetup(){const e=this.getView().getModel();const t=e.getProperty("/setupForm");const r=t.selectedProduct;if(!r){return}const s=e.getProperty("/overview");const a=s.find(e=>e.Product===r);if(a){e.setProperty("/setupForm",{selectedProduct:r,capPercent:a["Cap %"]||null,paymentStartDate:this._formatDateForPicker(a["Payment Start Date"])});o.show("Form reset to original values")}},_formatDateForPicker(e){if(!e){return null}let t;if(typeof e==="number"){t=this._excelDateToJSDate(e)}else{t=new Date(e)}const o=t.getFullYear();const r=String(t.getMonth()+1).padStart(2,"0");const s=String(t.getDate()).padStart(2,"0");return`${o}-${r}-${s}`},onAddSetup(){const e=this.getView().getModel("currentSetups").getData();const t=e||[];const r={product:"",capPercent:null,term:null,paymentFrequency:"",dataType:"",accountType:"",plan:"",payrollClassification:"",paymentStartDate:null,editable:true};t.push(r);this.getView().getModel("currentSetups").setData(t);this.getView().getModel("currentSetups").refresh();o.show("New setup row added")},onSetupRowSelect(e){const t=this.getView().getModel();const o=e.getSource();const r=o.getBindingContext();const s=r.getPath();const a=parseInt(s.split("/").pop());t.setProperty("/selectedSetupIndex",a)},onEditSetup(){const e=this.getView().getModel();const t=e.getProperty("/selectedSetupIndex");if(t===undefined){o.show("Please select a row to edit");return}e.setProperty(`/currentSetups/${t}/editable`,true);o.show("Row is now editable")},async onUploadSetups(){if(!this._pUploadSetupDialog){this._pUploadSetupDialog=a.load({id:this.getView().getId(),name:"commissionsaccounting.view.fragments.UploadSetupDialog",controller:this}).then(e=>{this.getView().addDependent(e);return e})}const e=await this._pUploadSetupDialog;e.open()},onSetupFileSelect(e){const t=e.getParameter("files")&&e.getParameter("files")[0];if(t){this._oSelectedSetupFile=t}else{this._oSelectedSetupFile=null}},async onUploadSetupFile(){if(!this._oSelectedSetupFile){r.warning("Please select a file to upload");return}if(!this._oSelectedSetupFile.name.match(/\.(xlsx|xls)$/)){r.error("Please upload a valid Excel file (.xlsx or .xls)");return}if(!window.XLSX){r.error("Excel processing library is still loading. Please try again in a moment.");return}s.show(0);try{const e=await this._readFileAsArrayBuffer(this._oSelectedSetupFile);const t=XLSX.read(new Uint8Array(e),{type:"array"});const a=t.Sheets[t.SheetNames[0]];const n=XLSX.utils.sheet_to_json(a);if(n.length===0){r.warning("The uploaded Excel file is empty");s.hide();return}const i=["Product","Cap %","Term","Payment Frequency","Payroll Classification","Payment Start Date"];const l=n[0];const c=i.filter(e=>!(e in l));if(c.length>0){r.error(`Missing required columns: ${c.join(", ")}`);s.hide();return}const d=n.map(e=>({product:e["Product"],capPercent:e["Cap %"],term:e["Term"],paymentFrequency:e["Payment Frequency"],payrollClassification:e["Payroll Classification"],paymentStartDate:this._formatDateForPicker(e["Payment Start Date"]),editable:false}));const p=d.map(e=>({product:e.product,capPercent:e.capPercent?parseInt(e.capPercent):null,term:parseInt(e.term),paymentFrequency:e.paymentFrequency,dataType:"",accountType:"",plan:null,payrollClassification:e.payrollClassification,paymentStartDate:e.paymentStartDate}));const u=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);const h=await fetch(`${u}/saveAmortizationSetup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({setupData:p})});if(!h.ok){throw new Error(`HTTP error! status: ${h.status}`)}await h.json();o.show(`Successfully uploaded and saved ${n.length} setup(s)`);await this.getCurrentSetups();this.onCloseUploadSetupDialog()}catch(e){r.error("Error processing setup file: "+e.message)}finally{s.hide()}},onCloseUploadSetupDialog(){this._pUploadSetupDialog.then(e=>{e.close();const t=this.byId("setupFileUploader");if(t){t.clear()}this._oSelectedSetupFile=null})},onDeleteSetup(e){const t=e.getParameter("listItem");const a=t.getBindingContext("currentSetups");const n=a.getObject();const i=n.product;r.confirm(`Are you sure you want to delete the setup for this product: ${i}?`,{title:"Confirm Deletion",onClose:async e=>{if(e===r.Action.OK){s.show(0);try{const e=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);const t=await fetch(`${e}/deleteAmortizationSetupByProduct`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product:i})});if(!t.ok){throw new Error(`HTTP error! status: ${t.status}`)}await t.json();const r=this.getView().getModel("currentSetups");const s=r.getData();const a=s.indexOf(n);if(a>-1){s.splice(a,1);r.setData(s);r.refresh()}o.show(`Setup for product "${i}" deleted successfully`)}catch(e){r.error(`Failed to delete setup: ${e.message}`)}finally{s.hide()}}}})},async onSaveSetups(){const e=this.getView().getModel("currentSetups");const t=e.getData()||[];if(t.length===0){r.warning("No setups to save");return}s.show(0);try{const r=t.map(e=>({product:e.product,capPercent:e.capPercent?parseInt(e.capPercent):null,term:parseInt(e.term),paymentFrequency:e.paymentFrequency,dataType:e.dataType,accountType:e.accountType,plan:e.plan||null,payrollClassification:e.payrollClassification,paymentStartDate:e.paymentStartDate}));const a=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);const n=await fetch(`${a}/saveAmortizationSetup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({setupData:r})});if(!n.ok){throw new Error(`HTTP error! status: ${n.status}`)}const i=await n.json();const l=t.map(e=>({...e,editable:false}));e.setProperty("/currentSetups",l);e.setProperty("/selectedSetupIndex",undefined);o.show("Setups saved successfully");s.hide()}catch(e){s.hide();r.error(`Failed to save setups: ${e.message}`)}}})});
//# sourceMappingURL=Main.controller.js.map